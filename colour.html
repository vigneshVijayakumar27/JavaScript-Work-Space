<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Studio Canvas Pro | American Modern Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
    <style>
        :root {
            --accent: #007AFF; /* Apple/Modern American Blue */
            --bg: #121212;
            --panel: #1E1E1E;
            --text: #F5F5F7;
        }

        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

        /* Page Management */
        .page { display: none; height: 100vh; width: 100vw; flex-direction: column; }
        .active { display: flex; }

        /* Welcome Page */
        #page1 { align-items: center; justify-content: center; background: linear-gradient(135deg, #121212 0%, #2c3e50 100%); }
        h1 { font-weight: 800; font-size: 3.5rem; letter-spacing: -2px; margin-bottom: 10px; }
        .start-btn { background: var(--accent); color: white; border: none; padding: 18px 45px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }

        /* Workspace Header */
        header { padding: 15px 30px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        
        /* Main Layout */
        .main-workspace { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar Tools */
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .tool-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 25px; }
        .tool-btn { background: #2c2c2e; border: 1px solid #3a3a3c; color: #fff; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; transition: 0.2s; text-align: center; }
        .tool-btn:hover { border-color: var(--accent); }
        .tool-btn.active { background: var(--accent); border-color: var(--accent); }

        /* Canvas Wrapper */
        .canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; padding: 20px; position: relative; }
        canvas { background: #fff; box-shadow: 0 0 50px rgba(0,0,0,0.5); cursor: crosshair; }

        .color-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .swatch { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .swatch.active { border-color: white; transform: scale(1.1); }
    </style>
</head>
<body>

    <section id="page1" class="page active">
        <h1>OUTLINE ART <span style="color:var(--accent)">PRO</span></h1>
        <p style="opacity: 0.5; margin-bottom: 30px;">Professional Digital Painting Simulator</p>
        <button class="start-btn" onclick="nav(2)">Enter Studio</button>
    </section>

    <section id="page2" class="page" style="align-items: center; justify-content: center;">
        <div style="background:var(--panel); padding: 50px; border-radius: 24px; text-align: center; border: 1px solid #333;">
            <h2>Import Reference</h2>
            <input type="file" id="fileInput" hidden onchange="handleFile(this.files[0])">
            <button class="start-btn" onclick="document.getElementById('fileInput').click()">Select from Computer</button>
            <p onclick="nav(1)" style="margin-top: 20px; font-size: 0.8rem; opacity: 0.5; cursor: pointer;">← Back to Home</p>
        </div>
    </section>

    <section id="page3" class="page">
        <header>
            <div style="cursor:pointer" onclick="nav(2)">← Project View</div>
            <div style="display:flex; gap: 15px;">
                <button class="tool-btn" onclick="undo()" title="Undo Action">⟲ Undo</button>
                <button class="tool-btn" onclick="downloadImage()" style="background:var(--accent)">Export 4K</button>
            </div>
        </header>

        <div class="main-workspace">
            <div class="sidebar">
                <label style="font-size: 0.7rem; opacity: 0.5;">CONVERTER SENSITIVITY</label>
                <input type="range" id="threshold" min="20" max="200" value="120" style="width:100%; margin: 10px 0 25px 0;" oninput="processArt()">

                <label style="font-size: 0.7rem; opacity: 0.5;">EQUIPMENT</label>
                <div class="tool-grid">
                    <button class="tool-btn active" onclick="setTool('brush', this)">Brush</button>
                    <button class="tool-btn" onclick="setTool('bucket', this)">Bucket</button>
                    <button class="tool-btn" onclick="setTool('spray', this)">Sprayer</button>
                    <button class="tool-btn" onclick="setTool('roller', this)">Roller</button>
                    <button class="tool-btn" onclick="setTool('shovel', this)">Putty Shovel</button>
                    <button class="tool-btn" onclick="setTool('sandpaper', this)">Sandpaper</button>
                </div>

                <label style="font-size: 0.7rem; opacity: 0.5;">SWATCHES</label>
                <div class="color-row" id="palette"></div>
                <input type="color" id="customColor" style="margin-top: 10px; width: 100%;">
            </div>

            <div class="canvas-container">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>
    </section>

    <script>
        let rawImage = null;
        let currentTool = 'brush';
        let currentColor = '#000000';
        let undoStack = [];
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        // Navigation
        function nav(n) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page'+n).classList.add('active');
        }

        // Color Palette
        const colors = ['#000000', '#FFFFFF', '#FF3B30', '#FF9500', '#FFCC00', '#4CD964', '#5AC8FA', '#007AFF', '#5856D6', '#AF52DE'];
        const palette = document.getElementById('palette');
        colors.forEach(c => {
            const div = document.createElement('div');
            div.className = 'swatch';
            div.style.background = c;
            div.onclick = () => {
                currentColor = c;
                document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
                div.classList.add('active');
            };
            palette.appendChild(div);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => { rawImage = img; nav(3); setTimeout(processArt, 100); };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function processArt() {
            if(!rawImage) return;
            const max = 700;
            const ratio = Math.min(max/rawImage.width, max/rawImage.height);
            canvas.width = rawImage.width * ratio;
            canvas.height = rawImage.height * ratio;
            ctx.drawImage(rawImage, 0, 0, canvas.width, canvas.height);

            let src = cv.imread(canvas);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
            let thres = parseInt(document.getElementById('threshold').value);
            cv.adaptiveThreshold(gray, gray, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, thres/10);
            cv.imshow('mainCanvas', gray);
            saveState(); // First state
            src.delete(); gray.delete();
        }

        function setTool(tool, btn) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Painting Logic
        let painting = false;
        canvas.onmousedown = (e) => { 
            if(currentTool === 'bucket') {
                const rect = canvas.getBoundingClientRect();
                floodFill(Math.round(e.clientX - rect.left), Math.round(e.clientY - rect.top));
                saveState();
            } else {
                painting = true; 
                ctx.beginPath();
            }
        };
        canvas.onmouseup = () => { if(painting) saveState(); painting = false; };
        canvas.onmousemove = (e) => {
            if(!painting || currentTool === 'bucket') return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineCap = 'round';
            ctx.strokeStyle = currentColor;

            if(currentTool === 'brush') { ctx.lineWidth = 5; ctx.globalAlpha = 1; }
            if(currentTool === 'spray') { ctx.lineWidth = 15; ctx.globalAlpha = 0.1; }
            if(currentTool === 'roller') { ctx.lineWidth = 30; ctx.globalAlpha = 1; ctx.lineCap = 'square'; }
            if(currentTool === 'sandpaper') { ctx.strokeStyle = '#fff'; ctx.lineWidth = 20; }
            if(currentTool === 'shovel') { ctx.lineWidth = 25; ctx.lineCap = 'butt'; ctx.globalAlpha = 0.8; }

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.moveTo(x, y);
        };

        // Step-by-Step Reset (Undo)
        function saveState() {
            if (undoStack.length > 20) undoStack.shift(); // Keep memory clean
            undoStack.push(ctx.getImageData(0,0,canvas.width, canvas.height));
        }

        function undo() {
            if (undoStack.length > 1) {
                undoStack.pop(); // Remove current
                ctx.putImageData(undoStack[undoStack.length - 1], 0, 0);
            }
        }

        // Simple Flood Fill for Bucket
        function floodFill(startX, startY) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const targetColor = getPixel(imageData, startX, startY);
            const fillRGB = hexToRgb(currentColor);
            if(colorsMatch(targetColor, fillRGB)) return;

            const stack = [[startX, startY]];
            while(stack.length > 0) {
                const [x, y] = stack.pop();
                if(x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                if(colorsMatch(getPixel(imageData, x, y), targetColor)) {
                    setPixel(imageData, x, y, fillRGB);
                    stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function getPixel(img, x, y) {
            const i = (y * img.width + x) * 4;
            return [img.data[i], img.data[i+1], img.data[i+2]];
        }
        function setPixel(img, x, y, c) {
            const i = (y * img.width + x) * 4;
            img.data[i]=c[0]; img.data[i+1]=c[1]; img.data[i+2]=c[2]; img.data[i+3]=255;
        }
        function colorsMatch(c1, c2) { return Math.abs(c1[0]-c2[0])<10 && Math.abs(c1[1]-c2[1])<10 && Math.abs(c1[2]-c2[2])<10; }
        function hexToRgb(h) {
            let m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);
            return m ? [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)] : [0,0,0];
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'studio-export.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>